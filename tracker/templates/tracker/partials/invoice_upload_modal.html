<!-- Invoice Upload & Extraction Modal - Extract-Only (No Manual Entry) -->
<div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title">
          <i class="fa fa-file-invoice me-2"></i>Upload & Extract Invoice for Order {{ order.order_number }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="invoiceUploadForm" method="post" action="{% url 'tracker:api_create_invoice_from_upload' %}">
        {% csrf_token %}
        <input type="hidden" name="selected_order_id" value="{{ order.id }}">
        {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
        {% if order.customer %}<input type="hidden" name="customer_id" value="{{ order.customer.id }}">{% endif %}
        {% if order.customer %}<input type="hidden" name="pre_selected_customer_id" value="{{ order.customer.id }}">{% endif %}

        <!-- Hidden fields for extracted data -->
        <div id="extractedHiddenFields"></div>

        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <!-- Info Alert -->
          <div class="alert alert-info mb-3 border-0" role="alert">
            <div class="d-flex align-items-center">
              <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
              <div>
                <strong>Upload Invoice PDF:</strong> Upload your invoice document to automatically extract customer and payment information. All extracted data will be displayed below for review before creating the invoice.
              </div>
            </div>
          </div>

          <!-- Upload Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-upload me-2"></i>Select PDF File</strong>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Invoice PDF File *</label>
                <input type="file" id="invoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760" required>
                <small class="text-muted">PDF files only. Maximum 50MB.</small>
              </div>

              <div id="uploadError" class="alert alert-danger" style="display:none" role="alert"></div>
              <div id="extractionSuccess" class="alert alert-success" style="display:none" role="alert">
                <i class="fa fa-check-circle me-2"></i>Invoice data extracted successfully! Review the extracted information below.
              </div>
              <div id="uploadProgress" class="progress" style="display:none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgressBar" role="progressbar" style="width: 0%"></div>
              </div>

              <button type="button" id="uploadBtn" class="btn btn-primary">
                <i class="fa fa-upload me-2"></i>Upload & Extract
              </button>
            </div>
          </div>

          <!-- Extracted Data Preview -->
          <div id="extractedDataPreview" style="display:none;" class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Information</strong>
              <small class="text-muted ms-2">Review before confirming</small>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
              <!-- Customer Information -->
              <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="fa fa-user me-2"></i>Customer</h6>
                <div class="row g-2">
                  <div class="col-md-6">
                    <small class="text-muted d-block">Name</small>
                    <p id="previewCustomerName" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Phone</small>
                    <p id="previewCustomerPhone" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Email</small>
                    <p id="previewCustomerEmail" class="mb-2">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Address</small>
                    <p id="previewCustomerAddress" class="mb-2">-</p>
                  </div>
                </div>
              </div>

              <hr class="my-3">

              <!-- Invoice Information -->
              <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="fa fa-file-invoice me-2"></i>Invoice Details</h6>
                <div class="row g-2">
                  <div class="col-md-6">
                    <small class="text-muted d-block">Invoice Number</small>
                    <p id="previewInvoiceNo" class="mb-2"><strong>-</strong></p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Invoice Date</small>
                    <p id="previewInvoiceDate" class="mb-2"><strong>-</strong></p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Code No</small>
                    <p id="previewCodeNo" class="mb-2">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Reference</small>
                    <p id="previewReference" class="mb-2">-</p>
                  </div>
                </div>
              </div>

              <hr class="my-3">

              <!-- Payment Information -->
              <div class="mb-0">
                <h6 class="text-muted mb-2"><i class="fa fa-money-bill me-2"></i>Payment Summary</h6>
                <div class="row g-2">
                  <div class="col-md-4">
                    <small class="text-muted d-block">Subtotal</small>
                    <p id="previewSubtotal" class="mb-0 fw-medium">-</p>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted d-block">Tax/VAT</small>
                    <p id="previewTax" class="mb-0 fw-medium">-</p>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted d-block">Total Amount</small>
                    <p id="previewTotal" class="mb-0 fs-6"><strong class="text-success">-</strong></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Additional Order Types Section -->
          <div id="additionalOrderTypesSection" class="card mb-3" style="display:none;">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <strong><i class="fa fa-layer-group me-2"></i>Additional Order Types</strong>
                <small class="text-muted ms-2">This invoice covers multiple order types</small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addOrderTypeBtn" data-bs-toggle="modal" data-bs-target="#addOrderTypeModal">
                <i class="fa fa-plus me-1"></i>Add
              </button>
            </div>
            <div class="card-body p-0">
              <div id="additionalOrderTypesList" class="list-group list-group-flush">
                <!-- Additional order types will be added here -->
              </div>
            </div>
          </div>

          <!-- Extracted Line Items -->
          <div id="extractedLineItemsSection" class="card mb-3" style="display:none;">
            <div class="card-header bg-light">
              <strong><i class="fa fa-list me-2"></i>Line Items</strong>
              <small class="text-muted ms-2">Items from invoice</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0 extracted-line-items-table">
                  <thead class="table-light">
                    <tr style="background-color: #f8f9fa;">
                      <th style="width: 5%; text-align: center;">#</th>
                      <th style="width: 10%;">Code</th>
                      <th style="width: 40%; word-break: break-word;">Description</th>
                      <th style="width: 10%;">Unit</th>
                      <th style="width: 8%; text-align: center;">Qty</th>
                      <th style="width: 12%; text-align: right;">Unit Price</th>
                      <th style="width: 15%; text-align: right;">Total</th>
                    </tr>
                  </thead>
                  <tbody id="lineItemsBody" class="extracted-line-items-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
          <div class="text-center w-100 mb-3">
            <p class="text-muted small mb-0">
              <i class="fa fa-info-circle me-1"></i>
              Upload an invoice PDF to extract data. Review the information and click Create to save the invoice.
            </p>
          </div>
          <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fa fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success btn-lg flex-grow-1" id="createInvoiceBtn" style="font-weight: 600;" disabled>
              <i class="fa fa-check-circle me-2"></i>Create Invoice
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.extracted-line-items-table {
  font-size: 0.85rem;
  width: 100%;
  table-layout: fixed;
}

.extracted-line-items-table thead {
  background-color: #f8f9fa;
  position: sticky;
  top: 0;
}

.extracted-line-items-table th,
.extracted-line-items-table td {
  padding: 0.6rem 0.4rem;
  vertical-align: middle;
  border: 1px solid #dee2e6;
}

.extracted-line-items-table th {
  font-weight: 600;
  text-align: left;
  background-color: #f8f9fa;
}

.extracted-line-items-table td {
  background-color: #fff;
}

@media (max-width: 1200px) {
  .extracted-line-items-table {
    font-size: 0.8rem;
  }
}

@media (max-width: 768px) {
  .extracted-line-items-table {
    font-size: 0.75rem;
  }

  .extracted-line-items-table th,
  .extracted-line-items-table td {
    padding: 0.4rem 0.25rem;
  }
}
</style>

<script>
(function() {
  const fileInput = document.getElementById('invoiceFile');
  const uploadBtn = document.getElementById('uploadBtn');
  const errorBox = document.getElementById('uploadError');
  const successMsg = document.getElementById('extractionSuccess');
  const progressWrap = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('uploadProgressBar');
  const previewSection = document.getElementById('extractedDataPreview');
  const lineItemsSection = document.getElementById('extractedLineItemsSection');
  const lineItemsBody = document.getElementById('lineItemsBody');
  const hiddenFieldsDiv = document.getElementById('extractedHiddenFields');
  const invoiceForm = document.getElementById('invoiceUploadForm');
  const createInvoiceBtn = document.getElementById('createInvoiceBtn');

  if (!uploadBtn) return;

  function getCSRF() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';');
    for (let i = 0; i < parts.length; i++) {
      const c = parts[i].trim();
      if (c.indexOf(name) === 0) return c.substring(name.length);
    }
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }

  function setProgress(p) {
    if (progressBar) progressBar.style.width = Math.max(0, Math.min(100, p)) + '%';
    if (progressWrap) progressWrap.style.display = p > 0 && p < 100 ? 'block' : (p >= 100 ? 'block' : 'none');
  }

  invoiceForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!fileInput.files || !fileInput.files[0]) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-warning me-2"></i>No PDF file was uploaded or extracted.';
      errorBox.className = 'alert alert-warning';
      return;
    }

    createInvoiceBtn.disabled = true;
    const originalBtnText = createInvoiceBtn.innerHTML;
    createInvoiceBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Creating...';

    try {
      const formData = new FormData(invoiceForm);

      const response = await fetch(invoiceForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const data = await response.json();

      if (data.success) {
        errorBox.style.display = 'none';
        successMsg.innerHTML = '<i class="fa fa-check-circle me-2"></i>Invoice created successfully! Redirecting...';
        successMsg.style.display = 'block';

        setTimeout(() => {
          if (data.redirect_url) {
            window.location.href = data.redirect_url;
          } else {
            window.location.reload();
          }
        }, 1500);
      } else {
        throw new Error(data.message || 'Failed to create invoice');
      }
    } catch (err) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>' + (err?.message || 'Failed to create invoice');
      errorBox.className = 'alert alert-danger';
      console.error('Form submission error:', err);
    } finally {
      createInvoiceBtn.disabled = false;
      createInvoiceBtn.innerHTML = originalBtnText;
    }
  });

  uploadBtn.addEventListener('click', async function() {
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.';
      errorBox.className = 'alert alert-warning';
      successMsg.style.display = 'none';
      return;
    }

    const file = fileInput.files[0];
    if (file.size > 50 * 1024 * 1024) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-warning me-2"></i>File is too large. Maximum size is 50MB.';
      errorBox.className = 'alert alert-warning';
      return;
    }

    errorBox.style.display = 'none';
    successMsg.style.display = 'none';
    setProgress(5);
    uploadBtn.disabled = true;
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Extracting...';

    try {
      const formData = new FormData();
      formData.append('file', file);

      const plateField = invoiceForm.querySelector('[name="plate"]');
      if (plateField && plateField.value) {
        formData.append('plate', plateField.value);
      }

      const orderIdField = invoiceForm.querySelector('[name="selected_order_id"]');
      if (orderIdField && orderIdField.value) {
        formData.append('selected_order_id', orderIdField.value);
      }

      const customerIdField = invoiceForm.querySelector('[name="customer_id"]');
      if (customerIdField && customerIdField.value) {
        formData.append('pre_selected_customer_id', customerIdField.value);
      }

      setProgress(10);

      const response = await fetch('{% url "tracker:api_upload_extract_invoice" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRF()
        }
      });

      setProgress(90);

      if (!response.ok) {
        throw new Error(`Server error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!data || !data.success) {
        throw new Error(data?.message || 'Extraction failed');
      }

      setProgress(100);

      const header = data.header || {};
      populatePreview(header);

      const items = data.items || [];
      populateLineItems(items);

      populateFormFields(header);

      successMsg.style.display = 'block';
      previewSection.style.display = 'block';
      if (items.length > 0) {
        lineItemsSection.style.display = 'block';
      }

      createInvoiceBtn.disabled = false;

      errorBox.style.display = 'none';

    } catch (err) {
      setProgress(0);
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>' + (err?.message || 'Upload failed');
      errorBox.className = 'alert alert-danger';
      successMsg.style.display = 'none';
      createInvoiceBtn.disabled = true;
      console.error('Extraction error:', err);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = originalText;
      setProgress(0);
    }
  });

  function populatePreview(header) {
    const map = {
      'previewCustomerName': 'customer_name',
      'previewCustomerPhone': 'phone',
      'previewCustomerEmail': 'email',
      'previewCustomerAddress': 'address',
      'previewInvoiceNo': 'invoice_no',
      'previewInvoiceDate': 'date',
      'previewCodeNo': 'code_no',
      'previewReference': 'reference'
    };

    Object.keys(map).forEach(elementId => {
      const el = document.getElementById(elementId);
      if (el) {
        const value = header[map[elementId]] || '-';
        el.textContent = value;
      }
    });

    if (document.getElementById('previewSubtotal')) {
      const subtotal = header.subtotal || 0;
      document.getElementById('previewSubtotal').textContent = parseFloat(subtotal).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    if (document.getElementById('previewTax')) {
      const tax = header.tax || 0;
      document.getElementById('previewTax').textContent = parseFloat(tax).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    if (document.getElementById('previewTotal')) {
      const total = header.total || 0;
      document.getElementById('previewTotal').textContent = parseFloat(total).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }
  }

  function populateLineItems(items) {
    lineItemsBody.innerHTML = '';
    hiddenFieldsDiv.innerHTML = '';

    if (!items || items.length === 0) {
      lineItemsSection.style.display = 'none';
      return;
    }

    lineItemsSection.style.display = 'block';

    items.forEach((item, idx) => {
      const code = item.code || '';
      const desc = item.description || '';
      const unit = item.unit || '';
      const qty = item.qty || 1;
      const rate = item.rate || 0;
      const value = item.value || (qty * rate);

      const row = document.createElement('tr');
      row.dataset.itemIndex = idx;
      row.innerHTML = `
        <td style="text-align: center;"><small>${idx + 1}</small></td>
        <td><small>${code}</small></td>
        <td><small>${desc}</small></td>
        <td><small>${unit}</small></td>
        <td style="text-align: center;"><small>${qty}</small></td>
        <td style="text-align: right;"><small>${parseFloat(rate).toLocaleString('en-US', {minimumFractionDigits: 2})}</small></td>
        <td style="text-align: right;"><small><strong>${value.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></small></td>
      `;
      lineItemsBody.appendChild(row);

      const fields = [
        { name: 'item_code[]', value: code },
        { name: 'item_description[]', value: desc },
        { name: 'item_unit[]', value: unit },
        { name: 'item_qty[]', value: qty },
        { name: 'item_price[]', value: rate },
        { name: 'item_value[]', value: value }
      ];

      fields.forEach(field => {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = field.name;
        inp.value = field.value;
        inp.dataset.itemIndex = idx;
        hiddenFieldsDiv.appendChild(inp);
      });
    });
  }

  function populateFormFields(header) {
    const customerName = header.customer_name || '';
    const customerPhone = header.phone || '';
    const customerEmail = header.email || '';
    const customerAddress = header.address || '';
    const invoiceNumber = header.invoice_no || '';
    const invoiceDate = header.date || '';
    const subtotal = header.subtotal || 0;
    const tax = header.tax || 0;
    const total = header.total || 0;

    const fields = [
      { name: 'customer_name', value: customerName },
      { name: 'customer_phone', value: customerPhone },
      { name: 'customer_email', value: customerEmail },
      { name: 'customer_address', value: customerAddress },
      { name: 'invoice_number', value: invoiceNumber },
      { name: 'invoice_date', value: formatDateForForm(invoiceDate) },
      { name: 'subtotal', value: subtotal },
      { name: 'tax_amount', value: tax },
      { name: 'total_amount', value: total },
      { name: 'code_no', value: header.code_no || '' },
      { name: 'reference', value: header.reference || '' }
    ];

    fields.forEach(field => {
      let inp = invoiceForm.querySelector(`[name="${field.name}"]`);
      if (!inp) {
        inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = field.name;
        hiddenFieldsDiv.appendChild(inp);
      }
      inp.value = field.value;
    });

    const sellerKeys = ['seller_name', 'seller_address', 'seller_phone', 'seller_email', 'seller_tax_id', 'seller_vat_reg'];
    sellerKeys.forEach(key => {
      if (header[key]) {
        let inp = invoiceForm.querySelector(`[name="${key}"]`);
        if (!inp) {
          inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = key;
          hiddenFieldsDiv.appendChild(inp);
        }
        inp.value = header[key];
      }
    });
  }

  function formatDateForForm(dateStr) {
    if (!dateStr) return '';
    const dateMatch = String(dateStr).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (dateMatch) {
      return dateMatch[3] + '-' + String(dateMatch[2]).padStart(2, '0') + '-' + String(dateMatch[1]).padStart(2, '0');
    }
    return dateStr;
  }
})();
</script>
